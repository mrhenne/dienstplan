<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan Pro - Helios Notaufnahme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617;
            --text-primary: #ffffff; 
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --table-header-bg: #0f172a;
            --row-hover: rgba(255, 255, 255, 0.05);
            --separator-color: rgba(255, 255, 255, 0.08);
            --holiday-color: rgba(234, 179, 8, 0.35);
            --weekend-color: rgba(59, 130, 246, 0.15);
            --zoom-factor: 1;
            --name-shadow: rgba(0,0,0,0.5);
        }

        .light-mode {
            --bg-color: #f8fafc;
            --text-primary: #0f172a; 
            --text-secondary: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --table-header-bg: #ffffff;
            --row-hover: rgba(59, 130, 246, 0.05); 
            --separator-color: rgba(15, 23, 42, 0.08);
            --holiday-color: rgba(234, 179, 8, 0.25);
            --weekend-color: rgba(59, 130, 246, 0.08);
            --name-shadow: rgba(15, 23, 42, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
            transition: background 0.4s ease, color 0.4s ease;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .name-col-bg {
            background: var(--bg-color) !important;
            box-shadow: 4px 0 12px -4px var(--name-shadow);
            z-index: 50;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(120, 120, 120, 0.3);
            border-radius: 10px;
        }

        .holiday-cell { background-color: var(--holiday-color) !important; }
        .weekend-cell { background-color: var(--weekend-color) !important; }
        
        /* Dezente Trennlinien zwischen den Zeilen */
        .row-separator td {
            border-bottom: 1px solid var(--separator-color);
        }

        .warning-cell {
            background-color: rgba(225, 29, 72, 0.15) !important;
            box-shadow: inset 0 0 10px rgba(225, 29, 72, 0.2);
        }

        #columnOverlay, #modalOverlay, #addEmpOverlay, #editEmpOverlay, #shiftModalOverlay, #yearViewOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 200; align-items: center; justify-content: center;
        }

        #rosterTable {
            zoom: var(--zoom-factor);
            transform-origin: top left;
        }

        .hidden-col { display: none !important; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; overflow: visible !important; }
            .sticky { position: static !important; }
        }
    </style>
</head>
<body class="p-2 md:p-6 h-screen flex flex-col">

    <!-- Jahresübersicht Modal -->
    <div id="yearViewOverlay" onclick="closeYearModal()">
        <div class="glass p-8 rounded-3xl w-[450px] shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black text-center flex items-center justify-center gap-3 text-current">
                <i data-lucide="calendar"></i> Jahresplaner <span id="yearDisplay" class="text-blue-500">2026</span>
            </h3>
            <div class="grid grid-cols-3 gap-3" id="monthGrid"></div>
            <div class="flex gap-2 justify-center border-t border-white/10 pt-4">
                <button onclick="changeYear(-1)" class="p-2 glass rounded-xl hover:bg-white/10 text-current transition-all"><i data-lucide="chevron-left"></i></button>
                <button onclick="closeYearModal()" class="px-8 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">Schließen</button>
                <button onclick="changeYear(1)" class="p-2 glass rounded-xl hover:bg-white/10 text-current transition-all"><i data-lucide="chevron-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Ansicht/Spalten Modal -->
    <div id="columnOverlay" onclick="closeColumnModal(event)">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-4 overflow-y-auto max-h-[80vh]" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-center text-current">Ansicht anpassen</h3>
            <div class="border-b border-white/10 pb-2 mb-2">
                <p class="text-[10px] uppercase font-black text-slate-500 mb-2">Infospalten</p>
                <div class="flex flex-col gap-2" id="columnToggleList"></div>
            </div>
            <div>
                <p class="text-[10px] uppercase font-black text-slate-500 mb-2">Schichten zählen (Tages-Statistik)</p>
                <div class="flex flex-wrap gap-2" id="shiftToggleList"></div>
            </div>
            <button onclick="closeColumnModal()" class="w-full py-3 mt-4 bg-blue-600 text-white rounded-xl font-bold">Fertig</button>
        </div>
    </div>

    <!-- Edit Mitarbeiter Modal -->
    <div id="editEmpOverlay">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-center text-current">Mitarbeiter bearbeiten</h3>
            <div class="flex flex-col gap-4 text-current">
                <input type="text" id="editEmpNameInput" placeholder="Name" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
                <input type="text" id="editEmpRoleInput" placeholder="Rolle" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-2 rounded-xl bg-black/5 text-current">Abbrechen</button>
                <button onclick="applyEditEmployee()" class="flex-1 py-2 rounded-xl bg-blue-600 text-white font-bold">Speichern</button>
            </div>
            <button onclick="confirmDeleteEmployee()" class="w-full py-2 border border-rose-500 text-rose-500 rounded-xl text-xs font-bold mt-2 hover:bg-rose-500/10 transition-all">Mitarbeiter entfernen</button>
        </div>
    </div>

    <!-- Slider Modal (Soll/Ü-Vormonat) -->
    <div id="modalOverlay">
        <div class="glass p-8 rounded-3xl w-80 shadow-2xl flex flex-col gap-6">
            <h3 class="text-lg font-bold text-center text-current" id="modalTitle">Anpassung</h3>
            <div class="flex flex-col gap-2 text-current">
                <div class="flex justify-between text-xs font-mono">
                    <span id="modalEmpName">Name</span>
                    <span id="sliderValueText" class="text-blue-500 font-bold">100%</span>
                </div>
                <input type="range" id="statusSlider" min="0" max="250" step="1" value="100" oninput="updateSliderLabel()" class="w-full h-2 bg-black/10 rounded-lg appearance-none cursor-pointer accent-blue-600">
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-2 rounded-xl bg-black/5 text-current">Abbrechen</button>
                <button onclick="applySliderValue()" class="flex-1 py-2 rounded-xl bg-blue-600 text-white font-bold">Anwenden</button>
            </div>
        </div>
    </div>

    <!-- Add Mitarbeiter Modal -->
    <div id="addEmpOverlay">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-4 text-current">
            <h3 class="text-lg font-bold text-center">Neuer Kollege</h3>
            <div class="flex flex-col gap-3">
                <input type="text" id="newEmpName" placeholder="Name, Vorname" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm">
                <input type="text" id="newEmpRole" placeholder="Rolle (z.B. Fachkraft)" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm">
                <input type="number" id="newEmpStatus" placeholder="Vz-Anteil (z.B. 100)" value="100" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm">
            </div>
            <div class="flex gap-2">
                <button onclick="closeAddEmpOverlay()" class="flex-1 py-2 rounded-xl bg-black/5">Abbrechen</button>
                <button onclick="addNewEmployee()" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white font-bold">Hinzufügen</button>
            </div>
        </div>
    </div>

    <!-- Dienste Modal -->
    <div id="shiftModalOverlay">
        <div class="glass p-8 rounded-3xl w-[500px] max-h-[80vh] shadow-2xl flex flex-col gap-6 overflow-hidden">
            <h3 class="text-lg font-bold text-center text-current">Dienste konfigurieren</h3>
            <div class="overflow-y-auto custom-scrollbar pr-2 flex flex-col gap-3" id="shiftTypeListContainer"></div>
            <div class="border-t border-white/10 pt-4 flex flex-col gap-4 text-current">
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" id="newShiftKey" placeholder="Kürzel" class="bg-black/5 border border-white/10 rounded-xl p-2 text-xs">
                    <input type="text" id="newShiftLabel" placeholder="Bezeichnung" class="bg-black/5 border border-white/10 rounded-xl p-2 text-xs">
                    <input type="number" step="0.1" id="newShiftHours" placeholder="Stunden" class="bg-black/5 border border-white/10 rounded-xl p-2 text-xs">
                </div>
                <button onclick="addShiftType()" class="w-full py-2 bg-emerald-600 text-white rounded-xl text-xs font-bold transition-all">Dienstart hinzufügen</button>
            </div>
            <button onclick="closeShiftModal()" class="py-3 rounded-xl bg-blue-600 text-white font-bold">Speichern & Schließen</button>
        </div>
    </div>

    <!-- Main Header -->
    <div class="max-w-full mx-auto flex flex-col h-full w-full relative z-10">
        <header class="glass flex flex-wrap items-center justify-between mb-4 p-4 rounded-2xl shadow-2xl no-print gap-4">
            <div class="flex items-center gap-4">
                <div class="w-11 h-11 bg-gradient-to-br from-blue-600 to-indigo-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i data-lucide="calendar" class="text-white" size="24"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-extrabold tracking-tight text-current">Dienstplan <span class="text-blue-400 italic text-sm">PRO</span></h1>
                        <div id="syncStatus" class="sync-indicator">
                            <i data-lucide="cloud-off" size="12" class="text-slate-400"></i>
                            <span class="text-slate-400 text-[10px]">Lokal</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Station: Notaufnahme | Helios Duisburg</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-black/5 px-4 py-2 rounded-xl border border-white/20">
                    <button onclick="adjustZoom(-0.05)" class="p-1 hover:bg-black/10 rounded-lg transition-colors text-slate-400"><i data-lucide="minus" size="14"></i></button>
                    <input type="range" id="zoomSlider" min="0.5" max="1.5" step="0.05" value="1" oninput="adjustZoom(0)" class="w-24 h-1 bg-black/10 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    <button onclick="adjustZoom(0.05)" class="p-1 hover:bg-black/10 rounded-lg transition-colors text-slate-400"><i data-lucide="plus" size="14"></i></button>
                    <span id="zoomText" class="text-[11px] font-black text-blue-500 min-w-[35px] ml-1">100%</span>
                </div>
                <div class="flex items-center gap-2 bg-black/5 p-1.5 rounded-xl border border-white/20">
                    <button onclick="changeMonth(-1)" class="p-1.5 hover:bg-white/20 rounded-lg text-current"><i data-lucide="chevron-left" size="18"></i></button>
                    <div id="monthLabel" onclick="openYearModal()" class="px-4 font-black text-sm min-w-[150px] text-center uppercase tracking-wider text-current cursor-pointer hover:text-blue-500 transition-all">Monat</div>
                    <button onclick="changeMonth(1)" class="p-1.5 hover:bg-white/20 rounded-lg text-current"><i data-lucide="chevron-right" size="18"></i></button>
                </div>
                <button onclick="openColumnModal()" class="px-4 py-2 glass rounded-xl text-xs flex items-center gap-2 font-bold text-current hover:bg-white/10 transition-all">
                    <i data-lucide="settings-2" size="14"></i> Ansicht
                </button>
            </div>

            <div class="flex gap-2">
                <div class="hidden xl:flex flex-col justify-center items-end mr-4 bg-blue-500/5 px-4 py-1 rounded-xl border border-blue-500/10">
                    <div class="text-[11px] font-black text-blue-500 uppercase tracking-widest" id="statWorkingDays">Arbeitstage: --</div>
                    <div class="text-[10px] font-bold text-slate-500" id="statTargetHours">Soll (100%): --h</div>
                </div>
                <button id="toggleWarningBtn" onclick="toggleWarnings()" class="px-3 py-1.5 bg-rose-500/10 text-rose-600 rounded-xl text-xs font-bold border border-rose-500/20 flex items-center gap-2">
                    <i data-lucide="alert-triangle" size="14"></i> Warnungen
                </button>
                <button onclick="openAddEmpOverlay()" class="px-3 py-1.5 bg-emerald-500/15 text-emerald-600 rounded-xl text-xs font-bold border border-emerald-500/20 flex items-center gap-2 hover:bg-emerald-500/25 transition-all">
                    <i data-lucide="user-plus" size="14"></i> Personal
                </button>
                <button id="themeToggle" onclick="toggleTheme()" class="px-3 py-1.5 glass rounded-xl text-xs text-current">
                    <i data-lucide="moon" id="themeIcon" size="16"></i>
                </button>
                <button id="saveBtn" onclick="saveData()" class="px-5 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-black shadow-lg flex items-center gap-2 transition-all">
                    <i data-lucide="save" size="16"></i> Sichern
                </button>
            </div>
        </header>

        <div class="flex flex-1 gap-4 overflow-hidden">
            <aside class="w-20 md:w-52 flex flex-col gap-3 overflow-y-auto no-print">
                <div class="glass p-4 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Dienste</p>
                        <button onclick="openShiftModal()" class="text-blue-500 hover:scale-110 transition-transform"><i data-lucide="settings-2" size="14"></i></button>
                    </div>
                    <div id="shiftPalette" class="flex flex-col gap-2.5"></div>
                </div>
            </aside>

            <main class="flex-1 glass rounded-3xl overflow-hidden flex flex-col shadow-2xl">
                <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar" id="tableContainer">
                    <table class="w-full border-separate border-spacing-0" id="rosterTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody" class="divide-y divide-black/5"></tbody>
                        <tfoot id="tableFoot" class="sticky bottom-0 z-40"></tfoot>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- State & Config ---
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : null;
        let auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'notaufnahme-duisburg';

        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/rosterSettings/globalConfig`;
        const DATA_DOC_PATH = `artifacts/${appId}/public/data/rosterData/mainPlan`;

        let viewSettings = JSON.parse(localStorage.getItem('view_settings')) || {
            status: true, soll: true, ist: true, diff: true, prev: true, total: true
        };
        
        let shiftCounterSettings = JSON.parse(localStorage.getItem('shift_counter_settings')) || {
            FD: true, SD: true, ND: true, LT: false, U: false, K: false, FE: false
        };

        const DEFAULT_EMPLOYEES = [
            { id: '1', name: 'Adams, Hendrik', role: 'Stationsleitung', status: '100%', prevOvertime: 0 },
            { id: '2', name: 'Fuchsa, Jennifer', role: 'stellv. Leitung', status: '100%', prevOvertime: 0 },
            { id: '3', name: 'Günter, Stephanie', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '4', name: 'Blank, Alexandra', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '5', name: 'Friedrich, Kristina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '6', name: 'Weienberg, Hanna', role: 'Fachkraft', status: '100%', prevOvertime: 0 },
            { id: '7', name: 'Hackmann, Matthias', role: 'Pflegekraft', status: '90%', prevOvertime: 0 },
            { id: '8', name: 'Buchmüller, Jörg', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '9', name: 'Rösken, Katrin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '10', name: 'Theißen, Jennifer', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '11', name: 'Daniels, Justin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '12', name: 'Kaymaz, Melda', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '13', name: 'Kühn, Philipp', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '14', name: 'Strachanski, Julia', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '15', name: 'Preußner, Pauline', role: 'Auszubildende', status: '100%', prevOvertime: 0 },
            { id: '16', name: 'Bielok, Lara', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '17', name: 'Wüstkamp, Bianca', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '18', name: 'Bondzau, Martina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
        ];

        let SHIFT_TYPES = JSON.parse(localStorage.getItem('helios_shifts')) || {
            FD: { label: 'Frühdienst', color: 'bg-cyan-400/90', textColor: 'text-cyan-950', hours: 7.7 },
            SD: { label: 'Spätdienst', color: 'bg-fuchsia-500/90', textColor: 'text-white', hours: 7.7 },
            ZD: { label: 'Zwischendienst', color: 'bg-indigo-500/90', textColor: 'text-white', hours: 7.7 },
            ND: { label: 'Nachtdienst', color: 'bg-orange-600/90', textColor: 'text-white', hours: 9.5 },
            LT: { label: 'Leitungstag', color: 'bg-emerald-400/90', textColor: 'text-emerald-950', hours: 7.7 },
            X:  { label: 'Frei', color: 'bg-white/10', textColor: 'text-slate-500', hours: 0 },
            U:  { label: 'Urlaub', color: 'bg-yellow-400/90', textColor: 'text-yellow-950', hours: 7.7 },
            K:  { label: 'Krank', color: 'bg-rose-500/90', textColor: 'text-white', hours: 7.7 }
        };

        let EMPLOYEES = JSON.parse(localStorage.getItem('helios_employees')) || DEFAULT_EMPLOYEES;
        let roster = JSON.parse(localStorage.getItem('helios_roster')) || {};
        let currentDate = new Date(2026, 3, 1);
        let activeShift = 'FD';
        let showWarnings = false;
        let editingEmpIndex = null;
        let editingField = 'status';

        function getEasterSunday(year) {
            const f = Math.floor, G = year % 19, C = f(year / 100), H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30, I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)), J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7, L = I - J, month = 3 + f((L + 40) / 44), day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        function getHolidaysNRW(year) {
            const easter = getEasterSunday(year);
            const addDays = (date, days) => { const res = new Date(date); res.setDate(res.getDate() + days); return res.toISOString().split('T')[0]; };
            return { [`${year}-01-01`]: "Neujahr", [addDays(easter, -2)]: "Karfreitag", [addDays(easter, 1)]: "Ostermontag", [`${year}-05-01`]: "Tag der Arbeit", [addDays(easter, 39)]: "Christi Himmelfahrt", [addDays(easter, 50)]: "Pfingstmontag", [addDays(easter, 60)]: "Fronleichnam", [`${year}-10-03`]: "Einheit", [`${year}-11-01`]: "Allerheiligen", [`${year}-12-25`]: "Weihnachten 1", [`${year}-12-26`]: "Weihnachten 2" };
        }

        function calculateWorkingDays(year, month) {
            const holidays = getHolidaysNRW(year);
            let count = 0; const d = new Date(year, month, 1);
            while (d.getMonth() === month) {
                const dayOfWeek = d.getDay(); const dateStr = d.toISOString().split('T')[0];
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidays[dateStr]) count++;
                d.setDate(d.getDate() + 1);
            }
            return count;
        }

        function renderRoster() {
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            const days = []; const d = new Date(year, month, 1);
            while (d.getMonth() === month) { days.push(new Date(d)); d.setDate(d.getDate() + 1); }
            
            const holidays = getHolidaysNRW(year);
            const workingDaysCount = calculateWorkingDays(year, month);
            const monthTargetHours = workingDaysCount * 7.7;
            
            document.getElementById('monthLabel').innerText = currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' });
            document.getElementById('statWorkingDays').innerText = `Arbeitstage: ${workingDaysCount}`;
            document.getElementById('statTargetHours').innerText = `Soll (100%): ${monthTargetHours.toFixed(1)}h`;
            
            const dailyCounts = {};
            days.forEach(day => {
                const key = day.toISOString().split('T')[0];
                dailyCounts[key] = {};
                Object.keys(SHIFT_TYPES).forEach(s => dailyCounts[key][s] = 0);
                EMPLOYEES.forEach(e => {
                    const s = (roster[e.id] || {})[key];
                    if (s && dailyCounts[key][s] !== undefined) dailyCounts[key][s]++;
                });
            });

            const head = document.getElementById('tableHead');
            const hidden = (key) => viewSettings[key] ? '' : 'hidden-col';

            let headHTML = `<tr class="sticky top-0 z-40 bg-[var(--table-header-bg)] backdrop-blur-md">
                <th class="p-4 text-left text-[11px] font-black border-b border-black/10 sticky left-0 z-50 name-col-bg min-w-[220px] uppercase text-current">MITARBEITER</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-current ${hidden('status')}">Vz/Tz</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-current ${hidden('soll')}">Soll</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-current ${hidden('ist')}">Ist</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-current ${hidden('diff')}">+/- Mt</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-blue-500 ${hidden('prev')}">Ü-Vormt</th>
                <th class="p-4 text-center text-[11px] font-black border-b border-black/10 text-orange-500 ${hidden('total')}">Ü-Gesamt</th>`;

            days.forEach(day => {
                const key = day.toISOString().split('T')[0];
                const isHoliday = !!holidays[key];
                const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                const isWarn = showWarnings && (dailyCounts[key].FD < 2 || dailyCounts[key].SD < 2 || dailyCounts[key].ND < 2);
                
                headHTML += `<th class="p-2 border-b border-black/5 min-w-[45px] ${isHoliday ? 'holiday-cell' : (isWeekend ? 'weekend-cell' : '')} ${isWarn ? 'warning-cell' : ''}">
                    <div class="flex flex-col items-center">
                        <span class="text-[9px] uppercase font-black text-slate-500">${day.toLocaleDateString('de-DE', { weekday: 'short' })}</span>
                        <span class="text-sm font-black ${isHoliday ? 'text-orange-600' : 'text-slate-400'}">${day.getDate()}</span>
                    </div>
                </th>`;
            });
            headHTML += `</tr>`;
            head.innerHTML = headHTML;

            const body = document.getElementById('tableBody'); body.innerHTML = '';
            EMPLOYEES.forEach((emp, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'group row-separator hover:bg-[var(--row-hover)] text-current transition-colors';
                let actual = 0; const empRoster = roster[emp.id] || {};
                const empTarget = monthTargetHours * ((parseFloat(emp.status) || 100) / 100);
                
                let daysHTML = "";
                days.forEach(day => {
                    const key = day.toISOString().split('T')[0];
                    const s = empRoster[key];
                    if (s && SHIFT_TYPES[s]) actual += SHIFT_TYPES[s].hours;
                    const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                    const isWarn = showWarnings && (dailyCounts[key].FD < 2 || dailyCounts[key].SD < 2 || dailyCounts[key].ND < 2);
                    
                    daysHTML += `<td onclick="toggleShift('${emp.id}', '${key}')" class="p-1 cursor-pointer border-r border-black/5 ${holidays[key] ? 'holiday-cell' : (isWeekend ? 'weekend-cell' : '')} ${isWarn ? 'warning-cell' : ''}">
                        <div class="h-9 w-full rounded-lg flex items-center justify-center text-[11px] font-black transition-all ${s ? `${SHIFT_TYPES[s].color} ${SHIFT_TYPES[s].textColor} shadow-lg scale-95` : 'hover:bg-blue-500/10'}">${s || ''}</div>
                    </td>`;
                });

                const diff = actual - empTarget;
                const totalÜ = diff + (parseFloat(emp.prevOvertime) || 0);

                tr.innerHTML = `<td class="p-4 sticky left-0 z-30 name-col-bg border-r border-black/5 shadow-xl">
                    <div class="font-black text-[13px] uppercase cursor-pointer hover:text-blue-500 transition-colors" onclick="openEditModal(${idx})">${emp.name}</div>
                    <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">${emp.role}</div>
                </td>
                <td class="p-2 text-center text-[11px] font-bold text-slate-400 cursor-pointer ${hidden('status')}" onclick="openSliderModal(${idx}, 'status')">${emp.status}</td>
                <td class="p-2 text-center text-[11px] font-mono text-slate-400 ${hidden('soll')}">${empTarget.toFixed(1)}</td>
                <td class="p-2 text-center text-[11px] font-black font-mono ${hidden('ist')}">${actual.toFixed(1)}</td>
                <td class="p-2 text-center text-[11px] font-black font-mono ${diff >= 0 ? 'text-emerald-500' : 'text-rose-500'} ${hidden('diff')}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}</td>
                <td class="p-2 text-center text-[11px] font-black font-mono text-blue-500 cursor-pointer ${hidden('prev')}" onclick="openSliderModal(${idx}, 'prevOvertime')">${emp.prevOvertime.toFixed(1)}h</td>
                <td class="p-2 text-center text-[11px] font-black font-mono ${totalÜ >= 0 ? 'text-orange-500' : 'text-rose-600'} ${hidden('total')}">${totalÜ > 0 ? '+' : ''}${totalÜ.toFixed(1)}h</td>
                ${daysHTML}`;
                body.appendChild(tr);
            });

            const foot = document.getElementById('tableFoot');
            let footHTML = "";
            const activeCounters = Object.keys(shiftCounterSettings).filter(s => shiftCounterSettings[s]);

            activeCounters.forEach((sCode, sIdx) => {
                const sInfo = SHIFT_TYPES[sCode];
                footHTML += `<tr class="bg-[var(--bg-color)]/90 backdrop-blur-sm ${sIdx === 0 ? 'border-t-2 border-blue-500/30' : ''} text-[10px] font-black text-current">
                    <td class="p-2 sticky left-0 z-50 name-col-bg border-r border-black/5 flex items-center gap-2">
                        <div class="w-4 h-4 rounded ${sInfo.color} flex items-center justify-center text-[8px] ${sInfo.textColor}">${sCode}</div>
                        <span class="text-[8px] uppercase tracking-tighter opacity-70">${sInfo.label}</span>
                    </td>
                    <td colspan="6" class="p-2 border-r border-black/5 text-right opacity-50 ${hidden('status') && hidden('soll') && hidden('ist') && hidden('diff') && hidden('prev') && hidden('total') ? 'hidden' : ''}">Tagessumme:</td>`;
                
                days.forEach(day => {
                    const key = day.toISOString().split('T')[0];
                    const count = dailyCounts[key][sCode] || 0;
                    const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                    footHTML += `<td class="p-1 text-center border-r border-black/5 ${isWeekend ? 'weekend-cell' : ''} ${count < 2 && (sCode==='FD'||sCode==='SD'||sCode==='ND') ? 'text-rose-500 underline decoration-2' : ''}">${count}</td>`;
                });
                footHTML += `</tr>`;
            });
            foot.innerHTML = footHTML;
            
            renderShiftPalette();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function adjustZoom(delta) {
            const slider = document.getElementById('zoomSlider');
            let val = parseFloat(slider.value) + delta;
            val = Math.max(0.5, Math.min(1.5, val));
            slider.value = val;
            document.documentElement.style.setProperty('--zoom-factor', val);
            document.getElementById('zoomText').innerText = Math.round(val * 100) + '%';
        }

        function openEditModal(i) { editingEmpIndex = i; const emp = EMPLOYEES[i]; document.getElementById('editEmpNameInput').value = emp.name; document.getElementById('editEmpRoleInput').value = emp.role; document.getElementById('editEmpOverlay').style.display = 'flex'; }
        function closeEditModal() { document.getElementById('editEmpOverlay').style.display = 'none'; }
        function applyEditEmployee() { if(editingEmpIndex !== null) { EMPLOYEES[editingEmpIndex].name = document.getElementById('editEmpNameInput').value; EMPLOYEES[editingEmpIndex].role = document.getElementById('editEmpRoleInput').value; renderRoster(); closeEditModal(); } }
        function confirmDeleteEmployee() { if(editingEmpIndex !== null && confirm('Soll dieser Kollege wirklich entfernt werden?')) { EMPLOYEES.splice(editingEmpIndex, 1); renderRoster(); closeEditModal(); } }

        function openAddEmpOverlay() { document.getElementById('addEmpOverlay').style.display = 'flex'; }
        function closeAddEmpOverlay() { document.getElementById('addEmpOverlay').style.display = 'none'; }
        function addNewEmployee() {
            const n = document.getElementById('newEmpName').value; const r = document.getElementById('newEmpRole').value; const s = document.getElementById('newEmpStatus').value + '%';
            if(!n) return; EMPLOYEES.push({ id: Date.now().toString(), name: n, role: r || "Pflegekraft", status: s, prevOvertime: 0 });
            renderRoster(); closeAddEmpOverlay();
        }

        function openShiftModal() { renderShiftTypeList(); document.getElementById('shiftModalOverlay').style.display = 'flex'; }
        function closeShiftModal() { document.getElementById('shiftModalOverlay').style.display = 'none'; renderRoster(); }
        function renderShiftTypeList() {
            const c = document.getElementById('shiftTypeListContainer'); c.innerHTML = '';
            Object.entries(SHIFT_TYPES).forEach(([k, v]) => {
                const d = document.createElement('div'); d.className = "flex items-center gap-2 bg-black/5 p-2 rounded-xl border border-white/5";
                d.innerHTML = `<div class="w-8 h-8 rounded-lg ${v.color} flex items-center justify-center font-black ${v.textColor}">${k}</div><input type="text" value="${v.label}" onchange="SHIFT_TYPES['${k}'].label=this.value" class="flex-1 bg-transparent text-[11px] font-bold text-current"><input type="number" step="0.1" value="${v.hours}" onchange="SHIFT_TYPES['${k}'].hours=parseFloat(this.value)" class="w-12 bg-black/10 rounded-lg text-center text-[11px] text-current"><button onclick="delete SHIFT_TYPES['${k}']; renderShiftTypeList()" class="p-1 text-rose-500"><i data-lucide="trash-2" size="12"></i></button>`;
                c.appendChild(d);
            });
            lucide.createIcons();
        }
        function addShiftType() {
            const k = document.getElementById('newShiftKey').value.toUpperCase().trim(); const l = document.getElementById('newShiftLabel').value; const h = parseFloat(document.getElementById('newShiftHours').value);
            if(!k || SHIFT_TYPES[k]) return; SHIFT_TYPES[k] = { label: l||k, hours: h||0, color: 'bg-blue-500', textColor: 'text-white' }; renderShiftTypeList();
        }

        function openSliderModal(i, f) { 
            editingEmpIndex = i; 
            editingField = f; 
            const emp = EMPLOYEES[i]; 
            document.getElementById('modalEmpName').innerText = emp.name;
            const s = document.getElementById('statusSlider');
            
            if(f === 'prevOvertime') {
                document.getElementById('modalTitle').innerText = 'Überstunden Vormonat';
                s.min = "-100";
                s.max = "200";
                s.step = "1";
                s.value = emp.prevOvertime;
            } else {
                document.getElementById('modalTitle').innerText = 'Beschäftigungsgrad';
                s.min = "0";
                s.max = "200";
                s.step = "1";
                s.value = parseInt(emp.status);
            }
            updateSliderLabel();
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function updateSliderLabel() {
            const val = document.getElementById('statusSlider').value;
            const suffix = editingField === 'prevOvertime' ? 'h' : '%';
            document.getElementById('sliderValueText').innerText = val + suffix;
        }

        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        
        function applySliderValue() { 
            const v = document.getElementById('statusSlider').value;
            if(editingField === 'prevOvertime') EMPLOYEES[editingEmpIndex].prevOvertime = parseFloat(v);
            else EMPLOYEES[editingEmpIndex].status = v + '%';
            renderRoster(); 
            closeModal(); 
        }

        function openColumnModal() {
            const colList = document.getElementById('columnToggleList'); colList.innerHTML = '';
            const colLabels = { status: 'Vz/Tz Anteil', soll: 'Soll', ist: 'Ist', diff: '+/- Monat', prev: 'Vormonat', total: 'Gesamt Ü.' };
            Object.keys(viewSettings).forEach(key => {
                const div = document.createElement('div'); div.className = "flex items-center justify-between p-2 bg-black/5 rounded-xl";
                div.innerHTML = `<span class="text-[11px] font-bold text-current">${colLabels[key]}</span><button onclick="toggleColumn('${key}')" class="w-10 h-5 rounded-full relative transition-all ${viewSettings[key] ? 'bg-blue-600' : 'bg-slate-300'}"><div class="absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${viewSettings[key] ? 'right-1' : 'left-1'}"></div></button>`;
                colList.appendChild(div);
            });
            const shiftList = document.getElementById('shiftToggleList'); shiftList.innerHTML = '';
            Object.keys(SHIFT_TYPES).forEach(key => {
                if(key === 'X') return;
                const btn = document.createElement('button');
                btn.onclick = () => toggleShiftCounter(key);
                btn.className = `px-3 py-1.5 rounded-xl text-[9px] font-black border transition-all ${shiftCounterSettings[key] ? 'bg-blue-600 text-white border-blue-500 shadow-md' : 'bg-black/5 border-white/5 text-slate-500'}`;
                btn.innerText = `${key}: ${SHIFT_TYPES[key].label}`;
                shiftList.appendChild(btn);
            });
            document.getElementById('columnOverlay').style.display = 'flex';
        }

        function toggleShiftCounter(key) { shiftCounterSettings[key] = !shiftCounterSettings[key]; localStorage.setItem('shift_counter_settings', JSON.stringify(shiftCounterSettings)); openColumnModal(); renderRoster(); }
        function toggleColumn(key) { viewSettings[key] = !viewSettings[key]; localStorage.setItem('view_settings', JSON.stringify(viewSettings)); openColumnModal(); renderRoster(); }
        function closeColumnModal() { document.getElementById('columnOverlay').style.display = 'none'; }

        function toggleShift(id, k) { if (!roster[id]) roster[id] = {}; roster[id][k] = (roster[id][k] === activeShift) ? null : activeShift; renderRoster(); }
        function changeMonth(o) { currentDate.setMonth(currentDate.getMonth() + o); renderRoster(); }
        function toggleTheme() { let mode = document.body.classList.toggle('light-mode'); localStorage.setItem('theme', mode ? 'light' : 'dark'); renderRoster(); }
        function toggleWarnings() { showWarnings = !showWarnings; document.getElementById('toggleWarningBtn').classList.toggle('bg-rose-500', showWarnings); renderRoster(); }
        function openYearModal() { document.getElementById('yearDisplay').innerText = currentDate.getFullYear(); renderMonthGrid(); document.getElementById('yearViewOverlay').style.display = 'flex'; }
        function closeYearModal() { document.getElementById('yearViewOverlay').style.display = 'none'; }
        function renderMonthGrid() { const container = document.getElementById('monthGrid'); container.innerHTML = ''; const months = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]; months.forEach((m, i) => { const btn = document.createElement('button'); const isCurrent = currentDate.getMonth() === i; btn.className = `p-4 rounded-2xl text-[10px] font-black uppercase transition-all border ${isCurrent ? 'bg-blue-600 text-white border-blue-500' : 'bg-black/5 border-white/5 text-current'}`; btn.innerText = m; btn.onclick = () => { currentDate.setMonth(i); renderRoster(); closeYearModal(); }; container.appendChild(btn); }); }
        function changeYear(o) { currentDate.setFullYear(currentDate.getFullYear() + o); document.getElementById('yearDisplay').innerText = currentDate.getFullYear(); renderMonthGrid(); }
        
        async function saveData() {
            localStorage.setItem('helios_employees', JSON.stringify(EMPLOYEES));
            localStorage.setItem('helios_shifts', JSON.stringify(SHIFT_TYPES));
            localStorage.setItem('helios_roster', JSON.stringify(roster));
            if (!db || !auth || !auth.currentUser) return;
            try {
                await db.doc(CONFIG_DOC_PATH).set({ employees: EMPLOYEES, shifts: SHIFT_TYPES, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                await db.doc(DATA_DOC_PATH).set({ roster: roster, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            } catch (err) {}
        }

        async function init() {
            if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
            renderRoster();
            if (firebaseConfig && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth(); db = firebase.firestore();
                    await auth.signInAnonymously();
                    const rosterDoc = await db.doc(DATA_DOC_PATH).get();
                    if (rosterDoc.exists) roster = rosterDoc.data().roster || {};
                    renderRoster(); 
                } catch (err) {}
            }
        }
        function renderShiftPalette() { const c = document.getElementById('shiftPalette'); c.innerHTML = ''; Object.entries(SHIFT_TYPES).forEach(([k, v]) => { const b = document.createElement('button'); b.className = `flex items-center gap-3 p-2 rounded-xl border transition-all ${activeShift===k?'bg-blue-500/10 border-blue-500':'bg-black/5 border-white/5 hover:bg-white/5'}`; b.onclick = () => { activeShift = k; renderShiftPalette(); }; b.innerHTML = `<div class="w-8 h-8 rounded-lg ${v.color} flex items-center justify-center font-black ${v.textColor} shadow-md">${k}</div><span class="text-[10px] font-bold uppercase hidden md:block text-current">${v.label}</span>`; c.appendChild(b); }); }

        window.onload = init;
    </script>
</body>
</html>
